#!/usr/bin/ruby

cache_folder = "#{ENV['HOME']}/.cache/simplecron"
config_folder = "#{ENV['HOME']}/.config/simplecron"
config_file = "#{config_folder}/config"

`mkdir -p #{cache_folder} #{config_folder}`

require 'date'

def no_config?(config_file)
  true unless File.file? config_file
end

def empty_config?(config_file)
  File.read(config_file).empty?
end

def is_enabled?
  true if `crontab -l 2>/dev/null`.include? 'SIMPLECRON'
end

def enable_simplecron
  cmd = '* * * * * /usr/bin/simplecron run #GENERATED BY SIMPLECRON' 
  setup = "(crontab -l 2>/dev/null; echo '#{cmd}') | crontab -"
  system(setup)
end

def disable_simplecron
  entry = ''
  `crontab -l 2>/dev/null`.split("\n").each do |task|
    entry += "#{task}\n" unless task.include? 'SIMPLECRON'
 end
  setup = "(echo '#{entry.strip}') | crontab -"
  system(setup)
end

def time_now
  DateTime.now.strftime('%s').to_i
end

def time_elapsed(control_file)
  last = 0
  last = File.read(control_file).to_i if File.file? control_file
  time_now - last
end

def convert_to_seconds(period)
  return period.delete('m').to_f * 60     if period.include?('m')
  return period.delete('h').to_f * 3600   if period.include?('h')
  return period.delete('d').to_f * 86400  if period.include?('d')
  return period.delete('w').to_f * 604800 if period.include?('w')
end

option = ARGV[0]
option ||= 'status'

case option

when 'status'
  puts 'simplecron is enabled' if is_enabled?
  puts 'simplecron is disabled' unless is_enabled?

when 'enable'
  exit 0 if is_enabled?
  
  enable_simplecron
  puts 'enabled simplecron'

when 'disable'
  exit 0 unless is_enabled?

  disable_simplecron
  puts 'disabled simplecron'

when 'run'
  exit 0 if no_config?(config_file)
  exit 0 if empty_config?(config_file)
  
  task_list = File.readlines(config_file)
  task_list.reject! { |l| l.include?('#') }
  
  task_list.each do |l|
    job = l.split(';')
    
    command = job[0].strip
    period = convert_to_seconds(job[1])
    control_file = "#{cache_folder}/#{job[2].strip}"
    
    if time_elapsed(control_file) >= period
      File.write(control_file, time_now, mode: 'w')
      system(command)
    end
  end
else
  puts "Command not found for simplecron: '#{option}'"
end
