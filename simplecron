#!/usr/bin/ruby

home = ENV['HOME']

cache_folder = "#{home}/.cache/simplecron"
config_folder = "#{home}/.config/simplecron"

`mkdir -p #{cache_folder} #{config_folder}`

config_file = "#{config_folder}/config"
logfile = "#{home}/.simplecron.log"

line = '=' * 40 

require 'date'

def no_config?(config_file)
  true unless File.file? config_file
end

def empty_config?(config_file)
  File.read(config_file).empty?
end

def is_enabled?
  true if `crontab -l 2>/dev/null`.include? '/usr/bin/simplecron'
end

def enable_simplecron
  cmd = '* * * * * /usr/bin/simplecron run' 
  setup = "(crontab -l 2>/dev/null; echo '#{cmd}') | crontab -"
  `#{setup} > /dev/null`
end

def disable_simplecron
  entry = ''
  `crontab -l 2>/dev/null`.split("\n").each do |task|
    entry += "#{task}\n" unless task.include? '/usr/bin/simplecron'
 end
  setup = "(echo '#{entry.strip}') | crontab -"
  `#{setup} > /dev/null`
end

def time_now
  DateTime.now.strftime('%s').to_i
end

def time_elapsed(control_file)
  last = 0
  last = File.read(control_file).to_i if File.file? control_file
  time_now - last
end

def convert_to_seconds(period)
  return period.delete('m').to_f * 60     if period.include?('m')
  return period.delete('h').to_f * 3600   if period.include?('h')
  return period.delete('d').to_f * 86400  if period.include?('d')
  return period.delete('w').to_f * 604800 if period.include?('w')
end

def stamp(job)
  ":: #{job.strip}\n:: #{Time.now.round(0)}\n"
end

option = ARGV[0]
option ||= 'status'

case option

when 'status'
  puts 'simplecron is enabled' if is_enabled?
  puts 'simplecron is disabled' unless is_enabled?

when 'enable'
  exit 0 if is_enabled?
  
  enable_simplecron
  puts 'enabled simplecron'

when 'disable'
  exit 0 unless is_enabled?

  disable_simplecron
  puts 'disabled simplecron'

when 'run'
  exit 0 if no_config?(config_file)
  exit 0 if empty_config?(config_file)
  
  task_list = File.readlines(config_file)
  task_list.reject! { |l| l.include?('#') }
  
  task_list.each do |l|
    job = l.split(';')
    
    command = job[2].strip
    period = convert_to_seconds(job[1])
    control = job[0].strip 

    control_file = "#{cache_folder}/#{control}"
    if time_elapsed(control_file) >= period
      File.write(logfile, stamp(control), mode: 'a')
      exit_code = `#{command} >> #{logfile} 2>&1; echo $?`.to_i
      File.write(logfile, line+"\n", mode: 'a')

      File.write(control_file, time_now, mode: 'w') if exit_code == 0
    end
  end
else
  puts "No option for simplecron: '#{option}'"
end
